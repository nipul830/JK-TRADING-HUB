<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JK Trading Hub â€” Market</title>
  <style>
    :root{--bg:#0e0e0e;--card:#151515;--line:#232323;--text:#f2f2f2;--muted:#9aa0a6;--green:#17c964;--red:#f31260}
    *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,Arial}
    .nav{position:sticky;top:0;background:#111;border-bottom:1px solid var(--line);display:flex;gap:6px;padding:10px 12px;z-index:9}
    .nav a{color:#ddd;text-decoration:none;padding:10px 12px;border-radius:8px}
    .nav a:hover,.nav a.active{background:#1f1f1f;color:#fff}
    .wrap{max-width:1100px;margin:18px auto;padding:0 14px}
    h1{margin:0 0 12px}
    .table{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .head,.row{display:grid;grid-template-columns:140px 110px 1fr 90px;gap:10px;align-items:center}
    .head{background:#101010;color:#bbb;font-weight:600}
    .head div,.row div{padding:12px 14px}
    .row{border-top:1px solid var(--line);cursor:pointer}
    .row:hover{background:#1a1a1a}
    .sym{display:flex;align-items:center;gap:10px;font-weight:600}
    .chg.pos{color:var(--green)} .chg.neg{color:var(--red)}
    .pill{display:inline-block;min-width:78px;padding:6px 10px;border-radius:999px;text-align:right;font-variant-numeric:tabular-nums}
    .pill.green{background:#0e2f1f;color:#8dffbf} .pill.red{background:#311017;color:#ff9db9}
    .muted{color:var(--muted)}
    .chartbox{height:52px}
    @media (max-width:700px){
      .head,.row{grid-template-columns:120px 90px 1fr 78px}
      .pill{min-width:68px}
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav class="nav">
    <a href="index.html">Home</a>
    <a class="active" href="market.html">Market</a>
    <a href="trade.html">Trade</a>
    <a href="discover.html">Discover</a>
    <a href="account.html">Account</a>
  </nav>

  <main class="wrap">
    <h1>Market</h1>
    <div class="table" id="marketTable">
      <div class="head">
        <div>Instrument</div>
        <div class="muted">Change</div>
        <div class="muted">Chart (15m)</div>
        <div class="muted">Last</div>
      </div>
      <!-- rows will be injected -->
    </div>
    <p class="muted" style="margin-top:10px">Prices & sparklines from Binance (15m, ~last 100 candles). Tap any row to open full chart on Trade page.</p>
  </main>

  <!-- Lightweight Charts for mini sparklines -->
  <script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>
  <script>
    const symbols = [
      'BTCUSDT','ETHUSDT','SOLUSDT','XRPUSDT',
      'DOGEUSDT','TRXUSDT','ADAUSDT','ETCUSDT'
    ];
    const tbl = document.getElementById('marketTable');

    // Create one row DOM
    function createRow(sym){
      const row = document.createElement('div');
      row.className='row';
      row.dataset.sym=sym;

      const c1 = document.createElement('div'); c1.className='sym'; c1.textContent = sym.replace('USDT','/USDT');
      const c2 = document.createElement('div'); c2.innerHTML = `<span class="pill muted">--</span>`;
      const c3 = document.createElement('div'); c3.className='chartbox'; // sparkline container
      const c4 = document.createElement('div'); c4.innerHTML = `<span class="pill muted" style="text-align:right">--</span>`;

      row.append(c1,c2,c3,c4);

      // click -> open trade page with hash (persists symbol)
      row.addEventListener('click',()=>location.href=`trade.html#${sym}`);

      tbl.appendChild(row);
      return {row, c1, c2, c3, c4};
    }

    // Fetch helpers
    async function getTicker24h(sym){
      const r = await fetch(`https://api.binance.com/api/v3/ticker/24hr?symbol=${sym}`);
      if(!r.ok) throw new Error('ticker failed');
      return r.json();
    }
    async function getKlines(sym, interval='15m', limit=100){
      const r = await fetch(`https://api.binance.com/api/v3/klines?symbol=${sym}&interval=${interval}&limit=${limit}`);
      if(!r.ok) throw new Error('klines failed');
      return r.json();
    }

    // Mini chart render
    function renderSpark(container, data){
      const chart = LightweightCharts.createChart(container, {
        width: container.clientWidth,
        height: container.clientHeight,
        layout:{background: { type: 'solid', color: 'transparent' }, textColor:'#9aa0a6'},
        rightPriceScale:{visible:false}, timeScale:{visible:false}, grid:{vertLines:{visible:false}, horzLines:{visible:false}},
        crosshair:{visible:false}
      });
      const series = chart.addAreaSeries({
        lineColor:'#12b886', topColor:'rgba(18,184,134,0.35)', bottomColor:'rgba(18,184,134,0.05)'
      });
      series.setData(data);
      // auto-resize
      new ResizeObserver(() => chart.applyOptions({ width: container.clientWidth })).observe(container);
      return chart;
    }

    // Populate all rows
    (async function init(){
      for(const sym of symbols){
        const {row, c2, c3, c4} = createRow(sym);

        // parallel fetch
        try{
          const [tkr, kl] = await Promise.all([getTicker24h(sym), getKlines(sym,'15m',100)]);

          // price & change
          const last = Number(tkr.lastPrice);
          const chg = Number(tkr.priceChangePercent);
          const pillLast = c4.querySelector('.pill');
          const pillChg = c2.querySelector('.pill');

          pillLast.textContent = last.toFixed(2);
          pillLast.classList.remove('muted'); pillLast.classList.add(chg>=0?'green':'red');

          pillChg.textContent = (chg>=0?'+':'') + chg.toFixed(2) + '%';
          pillChg.classList.remove('muted'); pillChg.classList.add(chg>=0?'green':'red');

          // sparkline data
          const data = kl.map(k => ({ time: Math.floor(k[0]/1000), value: Number(k[4]) }));
          renderSpark(c3, data);
        }catch(e){
          c3.innerHTML = '<span class="muted">data error</span>';
          console.error(sym, e);
        }
      }
    })();
  </script>
</body>
</html>
